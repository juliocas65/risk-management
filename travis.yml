sudo: enabled
language: "node_js"
node_js:
  - '12'

os:
  - linux

services:
  â€“ docker

env:
  global:
    - DOCKER_USERNAME="juliocas"
    - DOCKER_IMAGE_NAME="risk-management"
    - K8S_DEPLOYMENT_NAME="risk-management-deployment"

git:
  depth: 3

notifications:
  email:
    recipients:
      - juliocas65@gmail.com
    on_success: always
    on_failure: always

before_script:
  - docker pull ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}
  - docker login -u "${DOCKER_USERNAME}" -p "${DOCKER_PASSWORD}"

script:
  - npm run test:unit
  - npm run test:cov
  - npm run lint
  - docker run -v ${TRAVIS_BUILD_DIR}:/${DOCKER_IMAGE_NAME} ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME} -s /${DOCKER_IMAGE_NAME}

after_script:
  - docker build -t ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}:${TRAVIS_BUILD_ID} .
  - docker push ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}:${TRAVIS_BUILD_ID}
  - docker tag ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}:${TRAVIS_BUILD_ID} ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}:latest
  - docker push ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}:latest
  - sed -i -e 's|KUBE_CA_CERT|'"${KUBE_CA_CERT}"'|g' kubeconfig
  - sed -i -e 's|KUBE_ENDPOINT|'"${KUBE_ENDPOINT}"'|g' kubeconfig
  - sed -i -e 's|KUBE_ADMIN_CERT|'"${KUBE_ADMIN_CERT}"'|g' kubeconfig
  - sed -i -e 's|KUBE_ADMIN_KEY|'"${KUBE_ADMIN_KEY}"'|g' kubeconfig
  - sed -i -e 's|KUBE_USERNAME|'"${KUBE_USERNAME}"'|g' kubeconfig
  - docker run -v ${TRAVIS_BUILD_DIR}:/kube ${DOCKER_USERNAME}/kubectl kubectl --kubeconfig /kube/kubeconfig set image deployment/${K8S_DEPLOYMENT_NAME} ${K8S_DEPLOYMENT_NAME}=${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}:$TRAVIS_BUILD_ID
